DROP DATABASE IF EXISTS ESQLDB;
CREATE DATABASE IF NOT EXISTS ESQLDB;

USE ESQLDB;

SET SQL_SAFE_UPDATES=0;

DROP TABLE IF EXISTS LOGIN;
DROP TABLE IF EXISTS APPARTENENZA;
DROP TABLE IF EXISTS VINCOLO_INTEGRITA;
DROP TABLE IF EXISTS COMPLETAMENTO;
DROP TABLE IF EXISTS RISPOSTA;
DROP TABLE IF EXISTS CODICE;
DROP TABLE IF EXISTS RISPOSTA_CHIUSA;
DROP TABLE IF EXISTS ATTRIBUTO;
DROP TABLE IF EXISTS TABELLA;
DROP TABLE IF EXISTS MESSAGGIO;
DROP TABLE IF EXISTS TEST;
DROP TABLE IF EXISTS QUESITO_CODICE;
DROP TABLE IF EXISTS QUESITO_RISPOSTA_CHIUSA;
DROP TABLE IF EXISTS STUDENTE;
DROP TABLE IF EXISTS DOCENTE;


CREATE TABLE DOCENTE(
	MAIL VARCHAR(20),
	NOME VARCHAR(20),
	COGNOME VARCHAR(20),
	RECAPITO VARCHAR(20),
    DIPARTIMENTO VARCHAR(20) NOT NULL, 
    CORSO VARCHAR(20) NOT NULL,
    
    PRIMARY KEY (MAIL, NOME, COGNOME)
)
ENGINE=INNODB;

CREATE TABLE STUDENTE(
	MAIL VARCHAR(20),
	NOME VARCHAR(20),
	COGNOME VARCHAR(20),
	RECAPITO VARCHAR(20),
    ANNO_IMMATRICOLAZIONE CHAR(4) NOT NULL, 
    CODICE CHAR(16) NOT NULL,
    
	PRIMARY KEY (MAIL, NOME, COGNOME)
)
ENGINE=INNODB;

CREATE TABLE MESSAGGIO(
	TITOLO VARCHAR(20),
    TESTO VARCHAR(20) NOT NULL,
    DATA_INSERIMENTO DATE NOT NULL,
    MAIL_PROF VARCHAR(20) REFERENCES PROFESSORE.MAIL,
    NOME_PROF VARCHAR(20) REFERENCES PROFESSORE.NOME,
    COGNOME_PROF VARCHAR(20) REFERENCES PROFESSORE.COGNOME,
    MAIL_STUDENTE VARCHAR(20) REFERENCES STUDENTE.MAIL,
    NOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.NOME,
    COGNOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.COGNOME,
    TITOLO_TEST VARCHAR(20) REFERENCES TEST.TITOLO,
    
    PRIMARY KEY(TITOLO, MAIL_PROF, NOME_PROF, COGNOME_PROF, MAIL_STUDENTE, NOME_STUDENTE, COGNOME_STUDENTE, TITOLO_TEST)
)
ENGINE = INNODB;

CREATE TABLE TEST(
	TITOLO VARCHAR(20) NOT NULL,
    DATA_TEST DATE NOT NULL,
    FOTO VARCHAR(20),
    MAIL_PROF VARCHAR(20) REFERENCES PROFESSORE.MAIL,
    NOME_PROF VARCHAR(20) REFERENCES PROFESSORE.NOME,
    COGNOME_PROF VARCHAR(20) REFERENCES PROFESSORE.COGNOME,
    
    PRIMARY KEY(TITOLO, MAIL_PROF, NOME_PROF, COGNOME_PROF)
)
ENGINE = INNODB;

CREATE TABLE COMPLETAMENTO(
	STATO VARCHAR(20) NOT NULL,
    DATA_PRIMA DATE NOT NULL,
    DATA_ULTIMA DATE NOT NULL,
    MAIL_STUDENTE VARCHAR(20) REFERENCES STUDENTE.MAIL,
    NOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.NOME,
    COGNOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.COGNOME,
    TITOLO_TEST VARCHAR(20) REFERENCES TEST.TITOLO,
    
    PRIMARY KEY(MAIL_STUDENTE, NOME_STUDENTE, COGNOME_STUDENTE, TITOLO_TEST)
)
ENGINE = INNODB;

CREATE TABLE QUESITO_RISPOSTA_CHIUSA(

	ID INT AUTO_INCREMENT,
    LIVELLO VARCHAR(20) NOT NULL,
    DESCRIZIONE VARCHAR(20) NOT NULL,
    NUMERO_RISPOSTE INT NOT NULL,
    TITOLO_TEST VARCHAR(20),
    
    PRIMARY KEY(ID, TITOLO_TEST),
    FOREIGN KEY (TITOLO_TEST) REFERENCES TEST(TITOLO)
)
ENGINE = INNODB;

CREATE TABLE QUESITO_CODICE(
	ID INT AUTO_INCREMENT,
    LIVELLO VARCHAR(20) NOT NULL,
    DESCRIZIONE VARCHAR(20) NOT NULL,
    NUMERO_RISPOSTE INT NOT NULL,
    TITOLO_TEST VARCHAR(20) REFERENCES TEST.TITOLO,
    SKETCH VARCHAR(255),
    
    PRIMARY KEY(ID, TITOLO_TEST)
)
ENGINE = INNODB;

CREATE TABLE RISPOSTA(
	MAIL_STUDENTE VARCHAR(20) REFERENCES STUDENTE.MAIL,
    NOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.NOME,
    COGNOME_STUDENTE VARCHAR(20) REFERENCES STUDENTE.COGNOME,
    ID_QUESITO INT REFERENCES QUESITO.ID,
    
    PRIMARY KEY(MAIL_STUDENTE, NOME_STUDENTE, COGNOME_STUDENTE, ID_QUESITO)
)
ENGINE = INNODB;

CREATE TABLE TABELLA(
	NOME VARCHAR(20) NOT NULL,
    DATA_CREAZIONE DATE NOT NULL,
    NUMERO_RIGHE INT NOT NULL,
    MAIL_PROF VARCHAR(20) REFERENCES PROFESSORE.MAIL,
    NOME_PROF VARCHAR(20) REFERENCES PROFESSORE.NOME,
    COGNOME_PROF VARCHAR(20) REFERENCES PROFESSORE.COGNOME,
    
    PRIMARY KEY(NOME, MAIL_PROF, NOME_PROF, COGNOME_PROF)
)
ENGINE = INNODB;

CREATE TABLE ATTRIBUTO(
	NOME VARCHAR(20) NOT NULL,
    TIPO VARCHAR(20) NOT NULL,
    NOME_TABELLA VARCHAR(20) NOT NULL,
    
    PRIMARY KEY(NOME, NOME_TABELLA)
)
ENGINE = INNODB;
    
CREATE TABLE MESSAGGIO (
    TITOLO_MESSAGGIO VARCHAR(20),
    TESTO VARCHAR(20),
    DATA_INSERIMENTO DATE,
	TEST_TITOLO VARCHAR(20),
    DOCENTE_MAIL VARCHAR(20),
    DOCENTE_NOME VARCHAR(20),
    DOCENTE_COGNOME VARCHAR(20),
    STUDENTE_MAIL VARCHAR(20),
    STUDENTE_NOME VARCHAR(20),
    STUDENTE_COGNOME VARCHAR(20),
    PRIMARY KEY (TITOLO_MESSAGGIO),
    FOREIGN KEY (TEST_TITOLO) REFERENCES TEST(TITOLO),
    FOREIGN KEY (DOCENTE_MAIL, DOCENTE_NOME, DOCENTE_COGNOME) REFERENCES DOCENTE(MAIL, NOME, COGNOME),
    FOREIGN KEY (STUDENTE_MAIL, STUDENTE_NOME, STUDENTE_COGNOME) REFERENCES STUDENTE(MAIL, NOME, COGNOME)
  )
ENGINE=INNODB;

CREATE TABLE TABELLA(
    NOME VARCHAR(20),
    DATA_CEAZIONER DATE,
    NUMRIGHE INT,
    DOCENTE_MAIL VARCHAR(20),
    DOCENTE_NOME VARCHAR(20),
	DOCENTE_COGNOME VARCHAR(20),
    RISPOSTA_CHIUSA_ID INT,
    CODICE_ID INT,
    PRIMARY KEY (NOME),
    FOREIGN KEY (DOCENTE_MAIL) REFERENCES DOCENTE(MAIL),
    FOREIGN KEY (DOCENTE_NOME) REFERENCES DOCENTE(NOME),
    FOREIGN KEY (DOCENTE_COGNOME) REFERENCES DOCENTE(COGNOME),
	FOREIGN KEY (RISPOSTA_CHIUSA_ID) REFERENCES RISPOSTA_CHIUSA(ID),
    FOREIGN KEY (CODICE_ID) REFERENCES CODICE(ID)
)
ENGINE=INNODB;   

CREATE TABLE ATTRIBUTO (
    NOME VARCHAR(20),
    TIPO VARCHAR(20),
    TABELLA_NOME VARCHAR(20),
    PRIMARY KEY (NOME, TABELLA_NOME),
    FOREIGN KEY (TABELLA_NOME) REFERENCES TABELLA(NOME)
)
ENGINE=INNODB;


CREATE TABLE RISPOSTA_CHIUSA (
    ID INT NOT NULL,
    LIVELLO ENUM('BASSO', 'MEDIO', 'ALTO') NOT NULL,
    DESCRIZ VARCHAR(20),
    NUM_RISP INT,
    TEST_TITOLO VARCHAR(20) NOT NULL,
    PRIMARY KEY (ID, TEST_TITOLO),
    FOREIGN KEY (TEST_TITOLO) REFERENCES TEST(TITOLO)
)
ENGINE=INNODB;

CREATE TABLE CODICE (
    ID INT NOT NULL,
    LIVELLO ENUM('BASSO', 'MEDIO', 'ALTO') NOT NULL,
    DESCRIZ VARCHAR(20),
    NUM_RISP INT,
    TEST_TITOLO VARCHAR(20) NOT NULL,
    PRIMARY KEY (ID, TEST_TITOLO),
    FOREIGN KEY (TEST_TITOLO) REFERENCES TEST(TITOLO)
)
ENGINE=INNODB;

CREATE TABLE TEST (
    TITOLO VARCHAR(20) NOT NULL,
    DATA_CREAZIONE DATE,
    FOTO BLOB,
    DOCENTE_MAIL VARCHAR(20) NOT NULL,
    PRIMARY KEY (TITOLO),
    FOREIGN KEY (DOCENTE_MAIL) REFERENCES DOCENTE(MAIL)
)
ENGINE=INNODB;
	
CREATE TABLE RISPOSTA (
    ESITO BOOLEAN,
    TESTO VARCHAR(20),
	STUDENTE_MAIL VARCHAR(20),
    STUDENTE_NOME VARCHAR(20),
    STUDENTE_COGNOME VARCHAR(20),
    RISPOSTA_CHIUSA_ID INT,
    CODICE_ID INT,
    PRIMARY KEY (STUDENTE_MAIL, STUDENTE_NOME, STUDENTE_COGNOME, RISPOSTA_CHIUSA_ID, CODICE_ID),
    FOREIGN KEY (STUDENTE_MAIL, STUDENTE_NOME, STUDENTE_COGNOME) REFERENCES STUDENTE(MAIL, NOME, COGNOME),
    FOREIGN KEY (RISPOSTA_CHIUSA_ID) REFERENCES RISPOSTA_CHIUSA(ID),
    FOREIGN KEY (CODICE_ID) REFERENCES CODICE(ID)
)
ENGINE=INNODB;

CREATE TABLE COMPLETAMENTO (
    DATA_PRIMA DATE,
    DATA_ULTIMA DATE,
    STATO ENUM('APERTO', 'IN_COMPLETAMENTO', 'CONCLUSO'),
    STUDENTE_MAIL VARCHAR(20),
    STUDENTE_NOME VARCHAR(20),
    STUDENTE_COGNOME VARCHAR(20),
	TEST_TITOLO VARCHAR(20) NOT NULL,
    PRIMARY KEY (STUDENTE_MAIL, STUDENTE_NOME, STUDENTE_COGNOME, TEST_TITOLO),
    FOREIGN KEY (STUDENTE_MAIL, STUDENTE_NOME, STUDENTE_COGNOME) REFERENCES STUDENTE(MAIL, NOME, COGNOME),
    FOREIGN KEY (TEST_TITOLO) REFERENCES TEST(TITOLO)
)
ENGINE=INNODB;

CREATE TABLE VINCOLO_INTEGRITA (
	NOME_ATTRIBUTO VARCHAR(20),
    PRIMARY KEY(NOME_ATTRIBUTO ),
    FOREIGN KEY(NOME_ATTRIBUTO) REFERENCES ATTRIBUTO(NOME)
)
ENGINE=INNODB;

CREATE TABLE APPARTENENZA(
	ID_RISPOSTA_CHIUSA INT,
    ID_CODICE INT,
    TITOLO_TEST VARCHAR(20),
    NOME_TABELLA VARCHAR(20) REFERENCES TABELLA(NOME),
    MAIL_PROF VARCHAR(20),
    NOME_PROF VARCHAR(20),
    COGNOME_PROF VARCHAR(20),
    
    PRIMARY KEY(ID_RISPOSTA_CHIUSA,ID_CODICE , TITOLO_TEST, NOME_TABELLA, MAIL_PROF, NOME_PROF, COGNOME_PROF),
    FOREIGN KEY(ID_RISPOSTA_CHIUSA) REFERENCES QUESITO_RISPOSTA_CHIUSA(ID),
    FOREIGN KEY(ID_CODICE) REFERENCES QUESITO_CODICE(ID),
    -- FOREIGN KEY(TITOLO_TEST) REFERENCES QUESITO_RISPOSTA_CHIUSA(TITOLO_TEST),
    -- FOREIGN KEY(TITOLO_TEST) REFERENCES QUESITO_CODICE(TITOLO_TEST),
    FOREIGN KEY (TITOLO_TEST) REFERENCES TEST(TITOLO),
	FOREIGN KEY(MAIL_PROF, NOME_PROF, COGNOME_PROF) REFERENCES DOCENTE(MAIL, NOME, COGNOME)
    -- REFERENCES TABELLA(DOCENTE_MAIL, DOCENTE_NOME, DOCENTE_COGNOME)
    
)
ENGINE = INNODB;